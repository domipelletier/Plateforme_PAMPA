#-*- coding: latin-1 -*-

### File: test_load_packages.R
### Time-stamp: <2010-09-03 14:40:13 yreecht>
###
### Author: Yves Reecht
###
####################################################################################################
### Description:
###
### Scripts pour le chargement des packages et leur installation si besoin.
####################################################################################################


installPack.f <- function(pack)
{
    ## Purpose: Installation des packages manquants
    ## ----------------------------------------------------------------------
    ## Arguments: pack : liste des packages manquants (chaîne de caractères).
    ## ----------------------------------------------------------------------
    ## Author: Yves Reecht, Date:  3 sept. 2010, 13:43

    ## Packages disponibles en ligne :
    ## (si aucun dépôt n'est défini, le choix est donné à l'utilisateur).
    packDispo <- available.packages()[ , "Package"]

    ## Avertissement si des packages manquants ne sont pas disponibles :
    if (any(!is.element(pack, packDispo)))
    {
        tkmessageBox(message=paste("Le(s) package(s) : \n\n    * '",
                                   paste(pack[!is.element(pack, packDispo)], collapse="'\n    * '"),
                                   "'\n\nn'est (ne sont) pas disponible(s) !", sep=""),
                     icon="warning")

        res <- "error"
    }else{
        res <- "ok"
    }

    ## Installation des packages disponibles :
    if (any(is.element(pack, packDispo)))
    {
        install.packages(pack[is.element(pack, packDispo)], dependencies="Depends")
    }else{}

    return(res)
}

loadPackages.f <- function()
{
    ## Purpose: Charger les packages nécessaires et proposer l'installation
    ##          de ceux qui sont manquants.
    ## ----------------------------------------------------------------------
    ## Arguments: aucun
    ## ----------------------------------------------------------------------
    ## Author: Yves Reecht, Date:  3 sept. 2010, 12:58


    require(tcltk)

    ## Packages nécessaires au bon fonctionnement de la plateforme PAMPA WP2 :
    requiredPack <- c("tcltk", "tkrplot", "vegan", "MASS",
                      "rpart", "mvpart", "multcomp", "gamlss", "maps", "maptools")

    ## Packages installés :
    installedPack <- installed.packages()[ , "Package"]

    if (any(!is.element(requiredPack, installedPack)))
    {
        on.exit(tkdestroy(WinInstall))

        Done <- tclVar("0")             # Statut d'action utilisateur.

        ## Packages manquants :
        packManquants <- requiredPack[!is.element(requiredPack, installedPack)]

        ## Éléments d'interface :
        WinInstall <- tktoplevel()
        tkwm.title(WinInstall, "Packages manquants")

        B.Install <- tkbutton(WinInstall, text="   Installer   ", command=function(){tclvalue(Done) <- "1"})
        B.Cancel <- tkbutton(WinInstall, text="   Annuler   ", command=function(){tclvalue(Done) <- "2"})

        tkgrid(tklabel(WinInstall, text=" "))
        tkgrid(tklabel(WinInstall,
                       text=paste("Le(s) package(s) suivant(s) est (sont) manquant(s) :\n\    * '",
                                  paste(packManquants, collapse="'\n    * '"),
                                  "'\n\n Vous pouvez lancer leur installation \n",
                                  "(connection internet active et droits d'administration requis).", sep=""),
                       justify="left"),
               column=1, columnspan=3, sticky="w")

        tkgrid(tklabel(WinInstall, text=" "))

        tkgrid(B.Install, column=1, row=3, sticky="e")
        tkgrid(tklabel(WinInstall, text="       "), column=2, row=3)
        tkgrid(B.Cancel, column=3, row=3, sticky="w")

        tkgrid(tklabel(WinInstall, text=" "), column=4)

        tkbind(WinInstall, "<Destroy>", function(){tclvalue(Done) <- "2"})

        ## Attente d'une action de l'utilisateur :
        tkwait.variable(Done)

        if (tclvalue(Done) == "1")
        {
            tkdestroy(WinInstall)

            ## Installation des packages manquants :
            res <- installPack.f(pack=packManquants)
        }else{
            res <- "abord"
        }

    }else{
        ## Rien à faire, tous les packages requis sont installés.
        res <- "ok"
    }


    ## Traitement en fonction du statut de sortie :
    switch(res,
           ok = invisible(sapply(requiredPack, library, character.only=TRUE)),
           stop(paste("Vous devez installer manuellement le(s) package(s) :\n\n    * '",
                      paste(requiredPack[!is.element(requiredPack, installed.packages()[ , "Package"])],
                            collapse="\n    * '"),
                      "'", sep="")))
}

## On lance le chargement :
loadPackages.f()



### Local Variables:
### ispell-local-dictionary: "english"
### fill-column: 120
### End:
